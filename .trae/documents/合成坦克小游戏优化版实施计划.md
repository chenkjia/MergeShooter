## 概述
- 在现有渲染与场景骨架基础上（`game.js`:95–104、`game.js`:58–88），补齐合成、战斗、波次、金币与积分、重新开局、存储与排行榜，形成完整可玩循环。
- 主要落点：`src/scenes/gameScene.js`（核心循环与交互）、`src/entities/tank.js`（攻击/属性）、`src/entities/monster.js`（属性/行为），必要时新增轻量系统模块以保证清晰职责。

## 开局初始化
- 在 `gameScene.initialize`（`src/scenes/gameScene.js`:17–34）保留“两辆一级坦克”与首波3秒倒计时，并新增：
  - 读取本地/云端历史最高积分，更新当前 HUD 显示。
  - 初始化当前局状态：`wave=0, gold=0, score=0`；合成上限从持久化上限读取（默认5）。
  - 预计算战场与合成区域矩形，用于拖拽与落点校验。

## 合成与拖拽
- 触摸事件：在 `onTouchStart`（`src/scenes/gameScene.js`:60–62）基础上，扩展 `onTouchMove/onTouchEnd`（通过 `tt.onTouchMove/End` 在 `game.js` 同步转发），实现：
  - 命中检测：使用 `Tank.isTouched`（`src/entities/tank.js`:32–41）选择被拖拽坦克。
  - 拖拽更新：实时更新坦克位置并吸附到网格（合成区与战场区分别定义 50px 网格）。
  - 合成判定：在合成区并且两辆坦克等级相同时，移除两辆，生成更高一级坦克，更新属性与贴图（`resourceManager.images.tank_level_N`）。
  - 合成上限：场上坦克数不超过 `tankLimit`，超限阻止放置；Boss 击败时提升上限（见“波次与Boss”）。

## 战斗与攻击
- 在 `Tank.update`（`src/entities/tank.js`:28–30）实现自动攻击：
  - 属性：`attack = base * level`、`attackSpeed`（秒/次）、`range`（如 150px）。
  - 目标选择：从 `gameState.monsters` 选择最近且在射程内的怪物；首选血量最低或最近路径目标。
  - 伤害结算：按攻速定时器对目标扣血；目标死亡触发金币掉落与清理。
- 子弹系统可先简化为“瞬时弹道”（无实体），后续再可视化。

## 怪物与波次
- 新增轻量 `WaveManager`（建议 `src/systems/waveManager.js`）：
  - 基础间隔：初始 5s，每+1波缩短 0.1s，最低 1s。
  - 属性递增：血量与攻击力按固定比例随波次线性/指数提升（如 HP = base * (1 + 0.2*wave)、ATK = base * (1 + 0.15*wave)）。
  - 生成：普通波按设定数量与间隔生成怪物；每 10 波为精英波（属性×2，数量不变）；每 20 波为 Boss 波（单只怪，HP×10、ATK×5）。
- 在 `Monster` 中加入 `health/attack` 与 `type`（normal/elite/boss），完善 `update(gameArea)`（`src/entities/monster.js`:20–28）与路径行为；战场越界视为通关失败或扣分可后续定义。

## 金币与奖励
- 掉落与结算：
  - 通关每 1 波：掉落 `10 × 波次` 金币。
  - 每 10 波精英：掉落普通的 `3×`。
  - 每 20 波 Boss：掉落普通的 `10×`，并 `tankLimit += 2`（持久化保存）。
- 在 `gameScene.update/draw`（`src/scenes/gameScene.js`:36–58）维护 HUD（金币、波次、分数）。

## 积分与排行
- 当前局积分：`score = wave × 10 + highestTankLevel × 5`，在通关或合成后更新。
- 历史最高积分：本地持久化（`tt.setStorageSync/getStorageSync`）与云端同步：
  - 复用现有云函数示例（`cloudfunctions/quickstart`），封装接口：上报（写入集合）、查询Top10（按历史最高分降序）。
  - 前端展示排行榜前10（昵称、历史最高分），支持手动刷新与进入时自动刷新。

## 重新开局
- 在 HUD 增加“重新开局”按钮：触发重置：
  - 重置战场为初始地形；坦克回到“两辆基础级坦克”。
  - 怪物刷新回到第一波（3秒倒计时）。
  - 当前局积分清零；历史最高积分、已解锁皮肤、已提升合成上限保留不变（合成上限从持久化读取）。

## UI 与提示
- HUD：左上显示 `波次/金币/当前积分/历史最高`；右上“重新开局”；底部高亮合成区域与战场边界。
- 交互反馈：
  - 合成成功动画/音效（占位即可）。
  - 上限已满提示；Boss 击败与上限+2提示。

## 文件改动与职责
- `src/scenes/gameScene.js`：
  - 填充 `update/draw/onTouchStart` 交互与 HUD；集成 `WaveManager` 与奖惩结算；维护 `gameState`。
- `src/entities/tank.js`：
  - 完成攻击/射程/目标选择；保留 `isTouched` 命中检测。
- `src/entities/monster.js`：
  - 增加战斗属性与死亡状态；路径与边界处理；被击杀的金币与移除逻辑。
- 新增（精简）：
  - `src/systems/waveManager.js`：调度波次、生成怪物、难度递增、精英/Boss判定。
  - `src/services/storage.js`：本地存储与云端同步包装（最高分、合成上限、皮肤）。
  - `src/services/leaderboard.js`：Top10 查询与展示数据模型。

## 数据结构与常量
- `gameState` 扩展：`tanks[]/monsters[]/wave/gold/score/tankLimit/highestScore`。
- 常量：`GRID_SIZE=50`、`MIN_SPAWN_INTERVAL=1000ms`、`ATTACK_RANGE_DEFAULT=150`、`BOSS_LIMIT_INC=2`。

## 验证与里程碑
- 里程碑1：拖拽与合成在合成区生效，HUD显示基本数据；首波刷新可见。
- 里程碑2：自动攻击与怪物死亡、金币计算；普通波按规则递进。
- 里程碑3：精英与Boss波属性与奖励正确；击败Boss提升上限并持久化。
- 里程碑4：积分规则与排行榜接入；重新开局状态重置与持久化校验。
- 调试：在 `draw` 中临时绘制区域边界与射程圆，日志追踪波次与合成事件。

## 集成点参考
- 场景切换与主循环：`game.js`:58–88、95–104。
- 游戏场景骨架：`src/scenes/gameScene.js`:14–63。
- 坦克实体：`src/entities/tank.js`:3–14、16–41。
- 怪物实体：`src/entities/monster.js`:3–12、14–28。

## 交付说明
- 优先在现有文件内补齐逻辑；仅在职责需要时新增精简模块。
- 不引入第三方库；保持纯 JS 与现有抖音小程序 API。