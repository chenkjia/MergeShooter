## 目标与范围
- 依据《跨平台小游戏开发章程》对项目进行端到端的规范化、可维护性与性能优化，覆盖：语言与风格、模块化与状态管理、平台适配、渲染层统一、资源管理、测试与流程。
- 保证功能不变、性能稳定，形成可持续的自动化规范保障机制。

## 当前发现（代表性证据）
- 直接 Canvas 使用（违反“统一渲染层：Pixi.js”）：
  - `src/areas/ButtonArea.js:33–36`、`src/areas/ButtonArea.js:154–166`、`src/areas/ButtonArea.js:240–248`
  - `src/scenes/startScene.js:27–48`、`src/scenes/gameScene.js:86–120,136–138`、`src/entities/turretSlot.js:46–71`
- 平台 API 直连（需要通过适配层统一）：
  - `src/core/context.js:1–2,6–7,77`、`game.js:48–56`、`src/scenes/startScene.js:131`
- 适配层缺失：未发现项目自建 `adapter.js`（仅依赖 Pixi 内部环境适配）。
- 状态管理：未使用 XState（复杂流程未来需FSM化）。
- 资源路径：均在 `src/assets` 下，符合章程。

## 规范检查清单与评分标准
- 语言与风格
  - ES6+、`const/let`、模块化、统一命名（驼峰）、无未使用变量、无隐式全局、中文注释。
- 状态管理
  - 复杂流程必须使用 XState；核心逻辑尽量纯函数；数据不可变更新。
- 平台适配
  - 禁止在业务层直接调用 `tt.*`/`wx.*`；统一通过 `src/adapter/adapter.js`；提供优雅降级。
- 渲染层
  - 统一 Pixi.js：纹理、九宫格、交互与事件；禁止直接 `CanvasRenderingContext2D`。
- 资源管理
  - 所有资源位于 `src/assets`；通过 `PIXI.Texture` 统一加载与访问；禁止外链路径。
- 测试与性能
  - 单元/集成测试齐备；60 FPS 稳定（复杂场景≥45 FPS）；内存峰值≤200MB；启动<3s。

- 评分（每文件，0–5分/项，总分100）：
  - 渲染统一(20)、平台适配(20)、状态管理(20)、代码风格(20)、测试与性能(20)。
- 严重等级分类：
  - Critical：违反渲染统一/平台适配，功能或兼容性风险高。
  - Major：复杂流程未FSM化、缺测试，维护风险较高。
  - Moderate：命名/注释/模块边界问题，影响可读性。
  - Minor：格式、样式、重复代码等低风险问题。

## 执行步骤与产出
### 阶段1｜规范分析
- 将章程条款映射为 ESLint 规则与审查脚本；产出：检查清单、打分表、严重度字典。

### 阶段2｜代码审查
- 静态分析：运行 ESLint 与模式扫描（Canvas/平台API/DOM/Redux/XState/资源路径）。
- 人工逐行：重点文件（场景、区域、实体、核心上下文）。
- 产出：问题清单（含文件位置、严重等级、修复建议）。

### 阶段3｜优化实施（优先 Critical→Major）
- 渲染统一：
  - 将 `ctx.*` 绘制重构为 Pixi 显示对象（`Sprite`、`NineSlicePlane`、`Text`、`Graphics`）。
  - 统一交互：使用 Pixi 交互或平台触摸转发，不混用 DOM。
- 平台适配：
  - 新建 `src/adapter/adapter.js` 暴露平台能力（系统信息、触摸事件、存储、图片创建等）。
  - 业务层仅依赖适配层；`tt.*` 只存在于适配实现内，提供降级。
- 状态管理：
  - 为游戏主流程引入 XState（`start`→`playing`→`paused`→`gameover`），将合成/商店/战斗子流程建模。
  - 重构关键逻辑为纯函数，采用不可变更新策略。
- 代码风格与注释：
  - 建立 ESLint 配置，清理未使用变量/隐式全局；补充中文 JSDoc 注释与模块头注释。
- 测试与保障：
  - 为合成、消耗金币、炮台生成与合成规则添加单元测试；为触摸交互与场景切换添加集成测试。

### 阶段4｜验证
- 执行测试套件；在模拟与真机环境验证性能预算。
- 代码评审与规范对齐；生成优化报告（问题→修复→验证证据）。
- 更新项目文档（规范遵循说明、适配层说明、状态机图）。

### 阶段5｜持续改进
- 自动化：在 CI 中加入 ESLint/测试/资源路径校验；建立 FPS/内存监控脚本。
- 提交前钩子：`pre-commit` 执行 ESLint 与测试。
- 定期审查：每次版本前运行规范审计并归档报告。
- 规范文档治理：变更走评审并记录版本。

## 变更影响与风险控制
- 分支化实施（避免主干破坏），逐模块替换 Canvas→Pixi 并配套回归测试。
- 对适配层抽象进行最小增量替换，确保触摸链路稳定。
- 引入 XState 时先覆盖主流程，再逐步下沉至子流程（合成/商店）。

## 里程碑
- M1：完成审计与报告（含打分与严重度分类）。
- M2：完成渲染统一与适配层抽象的首批重构与测试通过。
- M3：引入主流程 XState 与关键逻辑纯函数化，测试齐备。
- M4：CI/钩子落地、性能验证与文档更新，关闭本轮优化。

## 需要确认
- 是否同意取消所有 Canvas 后备分支，统一使用 Pixi 渲染。
- 是否同意新增 `src/adapter/adapter.js` 并将平台 API 迁移入适配层。
- 是否同意为主流程引入 XState 并补充中文注释与测试。
